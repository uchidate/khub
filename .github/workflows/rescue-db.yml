name: ðŸš‘ Rescue Database

on:
  workflow_dispatch:

jobs:
  rescue:
    runs-on: ubuntu-latest
    steps:
      - name: Rescue DB
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Password to set
            NEW_PASS="Rescue_2024_HallyuHub!_Secure"
            
            echo "ðŸ” Checking containers..."
            if docker ps | grep -q hallyuhub-postgres-production; then
               echo "âœ… Database container is running."
            else
               echo "âš ï¸ Database container is NOT running. Trying to start it..."
               cd /var/www/hallyuhub
               docker-compose -f docker-compose.prod.yml up -d postgres-production
               sleep 10
            fi
            
            echo "ðŸ”§ Resetting DB Password..."
            # Try to reset password via docker exec (using postgres user which is superuser)
            # We use 'trust' or local socket which usually doesn't need password for 'postgres' user inside container
            docker exec hallyuhub-postgres-production psql -U postgres -c "ALTER USER hallyuhub WITH PASSWORD '$NEW_PASS';"
            
            if [ $? -eq 0 ]; then
               echo "âœ… Password reset successfully!"
            else
               echo "âŒ Failed to reset password. Trying alternative method..."
               # Fallback: try connecting as hallyuhub if postgres user fails (unlikely)
               docker exec hallyuhub-postgres-production psql -U hallyuhub -d hallyuhub_production -c "ALTER USER hallyuhub WITH PASSWORD '$NEW_PASS';" || echo "âŒ Second attempt failed."
            fi
            
            echo "ðŸ“ Recreating .env.production..."
            cd /var/www/hallyuhub
            
            # Start fresh but keep existing API keys if possible (we have TMDB in secrets context if this was a normal deploy, but here we hardcode what we know from previous context or just set the DB first)
            
            echo "# Auto-generated by Rescue Workflow" > .env.production
            echo "DATABASE_URL=postgresql://hallyuhub:$NEW_PASS@postgres-production:5432/hallyuhub_production" >> .env.production
            echo "POSTGRES_PASSWORD=$NEW_PASS" >> .env.production
            echo "NEXTAUTH_URL=https://www.hallyuhub.com.br" >> .env.production
            # Generating a random secret for NextAuth
            RAND_SECRET=$(openssl rand -base64 32)
            echo "NEXTAUTH_SECRET=$RAND_SECRET" >> .env.production
            echo "NODE_ENV=production" >> .env.production
            
            # We know this key exists and is needed
            echo "TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}" >> .env.production
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env.production
            
            chmod 600 .env.production
            
            echo "ðŸš€ Restarting App..."
            docker-compose -f docker-compose.prod.yml down hallyuhub
            docker-compose -f docker-compose.prod.yml up -d hallyuhub
            
            echo "âœ… Rescue Complete. Checking logs..."
            sleep 5
            docker-compose -f docker-compose.prod.yml logs --tail=20 hallyuhub
