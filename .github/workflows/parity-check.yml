name: üîç Staging/Production Parity Check

on:
  pull_request:
  workflow_dispatch:

jobs:
  check-parity:
    name: Verificar Paridade Staging/Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: üîç Verificar paridade no deploy.yml
        run: |
          echo "=================================================="
          echo "üîç VERIFICANDO PARIDADE STAGING/PRODUCTION"
          echo "=================================================="
          echo ""

          # Extrair jobs de staging e production
          # Para staging: remove linhas do header do pr√≥ximo bloco (coment√°rios ‚ïê‚ïê‚ïê e linhas vazias finais)
          sed -n '/^  deploy-staging:/,/^  [a-z-]*:/p' .github/workflows/deploy.yml | sed '/^  #.*‚ïê‚ïê‚ïê/,$d' | sed -e :a -e '/^\s*$/{ $d; N; ba; }' > /tmp/staging.yml
          sed -n '/^  deploy-production:/,/^  [a-z-]*:/p' .github/workflows/deploy.yml | sed -e :a -e '/^\s*$/{ $d; N; ba; }' > /tmp/production.yml

          # Normalizar diferen√ßas permitidas (whitelist)
          # CR√çTICO: Ordem importa - padr√µes MAIS ESPEC√çFICOS devem vir ANTES dos gen√©ricos
          ALLOWED_DIFFS=(
            # 1. Padr√µes de arquivo espec√≠ficos (antes de tudo)
            ".env.staging|.env.production"
            "docker-compose.staging.yml|docker-compose.prod.yml"

            # 2. URLs e caminhos (antes do padr√£o hallyuhub)
            "31.97.255.107:3001|www.hallyuhub.com.br"
            "staging.hallyuhub.com.br|www.hallyuhub.com.br"

            # 2b. Database URL: normalizar antes do gen√©rico staging|production
            "hallyuhub_staging|hallyuhub_production"

            # 2c. Ollama URL: ambos usam http:// ent√£o normalizar antes do gen√©rico http://|https://
            "http://ollama-staging|http://ollama-production"

            "http://|https://"

            # 3. Caminho compartilhado /var/www/hallyuhub (normaliza igual em ambos)
            "/var/www/hallyuhub|/var/www/hallyuhub"

            # 4. Refs do git (antes do gen√©rico staging|production)
            "refs/heads/staging|refs/heads/main"

            # 5. Nomes de containers espec√≠ficos
            # 5a. Padr√µes compostos ANTES dos simples (hallyuhub-postgres-X cont√©m postgres-X)
            "hallyuhub-postgres-staging|hallyuhub-postgres-production"
            "hallyuhub-staging|hallyuhub"
            "postgres-staging|postgres-production"
            "ollama-staging|ollama-production"

            # 6. Scripts espec√≠ficos de cada ambiente (equivalentes funcionais)
            "setup-auto-generation.sh|verify-production.sh"

            # 7. Nomes gen√©ricos de ambiente (AP√ìS padr√µes espec√≠ficos)
            "deploy-staging|deploy-production"
            "Deploy Staging|Deploy Production"
            "staging|production"
            "STAGING|PRODUCTION"
            "Staging|Production"

            # 8. Modelos de IA (staging=leve, production=qualidade)
            "gemma:2b|phi3:mini"

            # 9. Diferen√ßas de criticidade (staging=menor, production=maior)
            # CR√çTICO: Normalizar em AMBOS os lados para valores que aparecem nos dois ambientes
            "timeout_minutes: 20|timeout_minutes: 20"
            "timeout_minutes: 25|timeout_minutes: 25"
            "max_retries=10|max_retries=10"
            "max_retries=15|max_retries=15"
            "max_retries=18|max_retries=18"
            "max_retries=20|max_retries=25"
            "max_attempts=10|max_attempts=10"
            "max_attempts=12|max_attempts=12"
            "max_attempts=20|max_attempts=20"
            "sleep 3|sleep 3"
            "sleep 5|sleep 5"
            "sleep 10|sleep 10"

            # 10. Diferen√ßas visuais e estruturais permitidas
            "üü°|üü¢"
            "FASE 3a|FASE 3b"
            "restart: \"no\"|restart: always"
          )

          # Criar vers√µes normalizadas
          cp /tmp/staging.yml /tmp/staging-normalized.yml
          cp /tmp/production.yml /tmp/production-normalized.yml

          for diff_pattern in "${ALLOWED_DIFFS[@]}"; do
            staging_val=$(echo "$diff_pattern" | cut -d'|' -f1)
            production_val=$(echo "$diff_pattern" | cut -d'|' -f2)

            # Normalizar ambos para um valor neutro
            sed -i "s|$staging_val|NORMALIZED|g" /tmp/staging-normalized.yml
            sed -i "s|$production_val|NORMALIZED|g" /tmp/production-normalized.yml
          done

          # Remover trailing whitespace e linhas em branco no final (diferen√ßas cosm√©ticas)
          sed -i 's/[[:space:]]*$//' /tmp/staging-normalized.yml
          sed -i 's/[[:space:]]*$//' /tmp/production-normalized.yml

          # Comparar vers√µes normalizadas
          echo "üìä Comparando staging e production (ap√≥s normaliza√ß√£o)..."
          echo ""

          # Usar --ignore-matching-lines para diferen√ßas leg√≠timas que resistem √† normaliza√ß√£o:
          # - Scripts espec√≠ficos de cada ambiente (setup-auto-generation vs verify-production)
          # - Verifica√ß√£o SSL (produ√ß√£o apenas - staging usa http)
          # - NODE_ENV e argumentos espec√≠ficos de scripts
          # - scripts/NORMALIZED: invoca√ß√£o do script (staging usa NODE_ENV=X + flags, production n√£o)
          #   Ambas as linhas (+ e -) cont√™m "scripts/NORMALIZED", ent√£o a mudan√ßa √© ignorada
          if diff -u \
            --ignore-matching-lines='setup-auto-generation\|NODE_ENV=\|--no-test\|Verify SSL\|certificado SSL\|hallyuhub.com.br\|scripts/NORMALIZED\|DATABASE_URL\|ALTER USER\|docker exec.*psql\|pg_isready' \
            /tmp/staging-normalized.yml /tmp/production-normalized.yml > /tmp/diff-result.txt; then
            echo "‚úÖ SUCESSO: Staging e Production s√£o espelhos perfeitos!"
            echo ""
            echo "Diferen√ßas permitidas (particularidades de ambiente):"
            for diff_pattern in "${ALLOWED_DIFFS[@]}"; do
              echo "  - $diff_pattern"
            done
            exit 0
          else
            echo "‚ùå FALHA: Encontradas diferen√ßas N√ÉO autorizadas!"
            echo ""
            echo "=================================================="
            echo "DIFEREN√áAS DETECTADAS:"
            echo "=================================================="
            cat /tmp/diff-result.txt
            echo ""
            echo "=================================================="
            echo "REGRA: Staging e Production DEVEM ser espelhos!"
            echo "=================================================="
            echo ""
            echo "Apenas as seguintes diferen√ßas s√£o permitidas:"
            for diff_pattern in "${ALLOWED_DIFFS[@]}"; do
              echo "  ‚úÖ $diff_pattern"
            done
            echo ""
            echo "Qualquer outra diferen√ßa DEVE ser corrigida antes do merge."
            exit 1
          fi

      - name: üîç Verificar paridade nos docker-compose
        run: |
          echo ""
          echo "=================================================="
          echo "üîç VERIFICANDO DOCKER-COMPOSE FILES"
          echo "=================================================="

          # Verificar se estrutura de services √© id√™ntica
          staging_services=$(grep -E "^  [a-z-]+:" docker-compose.staging.yml | sort)
          prod_services=$(grep -E "^  [a-z-]+:" docker-compose.prod.yml | sort)

          # Normalizar nomes
          # staging: hallyuhub-staging ‚Üí hallyuhub-XXX, outros-staging ‚Üí outros-XXX
          # production: hallyuhub (sem sufixo) ‚Üí hallyuhub-XXX, outros-production ‚Üí outros-XXX
          staging_services_norm=$(echo "$staging_services" | sed 's/-staging/-XXX/g')
          prod_services_norm=$(echo "$prod_services" | sed 's/-production/-XXX/g')
          # Caso especial: app container de production √© 'hallyuhub' (n√£o 'hallyuhub-production')
          prod_services_norm=$(echo "$prod_services_norm" | sed 's/^  hallyuhub:$/  hallyuhub-XXX:/')

          if [ "$staging_services_norm" == "$prod_services_norm" ]; then
            echo "‚úÖ Services id√™nticos em staging e production"
          else
            echo "‚ùå FALHA: Services diferentes entre staging e production!"
            echo ""
            echo "Staging services:"
            echo "$staging_services"
            echo ""
            echo "Production services:"
            echo "$prod_services"
            exit 1
          fi

          echo "‚úÖ Paridade de docker-compose validada"

      - name: üìã Resumo da Verifica√ß√£o
        if: success()
        run: |
          echo ""
          echo "=================================================="
          echo "‚úÖ PARIDADE VALIDADA COM SUCESSO!"
          echo "=================================================="
          echo ""
          echo "Staging e Production s√£o espelhos perfeitos."
          echo "Apenas particularidades de ambiente diferem."
          echo ""
          echo "Este PR est√° aprovado para merge."
