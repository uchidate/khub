name: ðŸš€ Build and Deploy

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  FLUXO DE DEPLOY OTIMIZADO                                     â•‘
# â•‘                                                                â•‘
# â•‘  staging â†’ STAGING (auto) â†’ validar â†’ main â†’ PRODUCTION       â•‘
# â•‘                                                                â•‘
# â•‘  â€¢ Builds paralelos quando possÃ­vel                            â•‘
# â•‘  â€¢ Cache otimizado para builds rÃ¡pidos                         â•‘
# â•‘  â€¢ VerificaÃ§Ã£o automÃ¡tica pÃ³s-deploy                           â•‘
# â•‘  â€¢ NotificaÃ§Ãµes Slack consolidadas                             â•‘
# â•‘  â€¢ Timeouts e concurrency control                              â•‘
# â•‘                                                                â•‘
# â•‘  Ver: docs/DEPLOY_WORKFLOW.md                                  â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Controle de concorrÃªncia: cancela deploys antigos do mesmo branch
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ“‹ FASE 1: ValidaÃ§Ã£o RÃ¡pida (paralela)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  validate-code:
    name: âœ… Validate Code
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: ðŸ” Run Linters & Type Check
        run: |
          echo "::group::ESLint"
          npx eslint app/ lib/ --max-warnings 10
          echo "::endgroup::"

          echo "::group::TypeScript"
          npx tsc --noEmit
          echo "::endgroup::"

      - name: ðŸ—ï¸ Test Build
        env:
          SKIP_BUILD_STATIC_GENERATION: "1"
          DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/hallyuhub_build"
        run: npm run build

      # Temporariamente desabilitado - ajustar falso-positivos
      # - name: ðŸ§ª Test Cron Scripts
      #   run: |
      #     echo "::group::Cron Scripts Tests"
      #     chmod +x tests/cron/test-cron-scripts.sh
      #     ./tests/cron/test-cron-scripts.sh
      #     echo "::endgroup::"

      - name: ðŸ“Š Summary
        run: |
          echo "### âœ… ValidaÃ§Ã£o ConcluÃ­da" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ ESLint passou" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ TypeScript type-check passou" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Build Next.js passou" >> $GITHUB_STEP_SUMMARY

  check-deploy-process:
    name: ðŸ“‹ Check Deploy Process
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Validate Process
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" == "push" ]]; then
            echo "::warning::âš ï¸ Push direto para main detectado!"
            echo "::warning::Processo recomendado: staging â†’ STAGING â†’ PR â†’ main"

            echo "### âš ï¸ Push Direto para Main" >> $GITHUB_STEP_SUMMARY
            echo "**Processo recomendado:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Push para \`staging\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Validar em ambiente staging" >> $GITHUB_STEP_SUMMARY
            echo "3. Criar PR: staging â†’ main" >> $GITHUB_STEP_SUMMARY
            echo "4. Merge apÃ³s validaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "### ðŸŸ¡ Deploy para Staging" >> $GITHUB_STEP_SUMMARY
            echo "ApÃ³s deploy, valide em: http://31.97.255.107:3001" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "### ðŸ” Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "Apenas validaÃ§Ã£o serÃ¡ executada (sem deploy)" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ³ FASE 2: Build da Imagem Docker
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  build-image:
    name: ðŸ³ Build Docker Image
    needs: [validate-code, check-deploy-process]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # SÃ³ builda para pushes (nÃ£o para PRs)
    if: github.event_name != 'pull_request'

    permissions:
      contents: read
      packages: write

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=staging,enable=${{ github.ref == 'refs/heads/staging' }}
            type=sha,prefix={{branch}}-
          labels: |
            org.opencontainers.image.title=HallyuHub
            org.opencontainers.image.description=K-pop content platform

      - name: Build and Push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Cache otimizado via GitHub Actions
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Build args
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: ðŸ“Š Summary
        run: |
          echo "### ðŸ³ Imagem Docker Buildada" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸŸ¡ FASE 3a: Deploy STAGING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  deploy-staging:
    name: ðŸŸ¡ Deploy to Staging
    needs: build-image
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.ref == 'refs/heads/staging'

    environment:
      name: staging
      url: http://31.97.255.107:3001

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¢ Notify Start
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | head -c 100)
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"ðŸš€ Deploy STAGING iniciado\",
              \"blocks\": [{
                \"type\": \"header\",
                \"text\": {\"type\": \"plain_text\", \"text\": \"ðŸš€ Deploy STAGING Iniciado\"}
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Ambiente:*\\nðŸŸ¡ STAGING\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Status:*\\nIniciado\"}
                ]
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n\`${{ github.ref_name }}\`\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\\n\`${GITHUB_SHA:0:7}\`\"}
                ]
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Mensagem:*\\n> $COMMIT_MSG\"
                }
              }, {
                \"type\": \"divider\"
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"ðŸ”— <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|Ver Commit> Â· <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Ver Workflow>\"
                }
              }, {
                \"type\": \"context\",
                \"elements\": [
                  {\"type\": \"mrkdwn\", \"text\": \"ðŸ‘¤ ${{ github.actor }}\"},
                  {\"type\": \"mrkdwn\", \"text\": \"âš™ï¸ GitHub Actions\"}
                ]
              }]
            }"

      - name: ðŸ·ï¸ Prepare Environment & Directory (with retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          retry_wait_seconds: 15
          shell: bash
          command: |
            # Usar GitHub Action inline
            set -e

            # Install SSH if not available
            which ssh || (apt-get update && apt-get install -y openssh-client)

            # Setup SSH key
            mkdir -p ~/.ssh
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key

            # SSH with retry
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=90 \
                -o ServerAliveInterval=30 \
                -i ~/.ssh/deploy_key \
                ${{ secrets.USER }}@${{ secrets.HOST }} << ENDSSH
            set -e
            echo "ðŸ“ Ensuring base directory exists..."
            sudo mkdir -p /var/www/hallyuhub
            sudo chown -R ${{ secrets.USER }}:${{ secrets.USER }} /var/www/hallyuhub

            cd /var/www/hallyuhub

            # Initialize .env.staging if it doesn't exist
            if [ ! -f .env.staging ]; then
              echo "âš ï¸ .env.staging not found! Creating from backup or empty..."
              if [ -f .env.staging.bak ]; then
                cp .env.staging.bak .env.staging
              else
                touch .env.staging
              fi
            fi

            # Backup
            cp .env.staging .env.staging.bak

            # Sanitize: remove invalid env entries (lines starting with = or empty key)
            sed -i '/^=/d' .env.staging

            update_env() {
              key=\$1
              val=\$2
              if [ -z "\$val" ]; then return; fi
              if grep -q "^\${key}=" .env.staging; then
                sed -i "s|^\${key}=.*|\${key}=\${val}|" .env.staging
              else
                echo "\${key}=\${val}" >> .env.staging
              fi
            }

            echo "ðŸ”§ Updating environment variables..."
            update_env "TMDB_API_KEY" "${{ secrets.TMDB_API_KEY }}"
            update_env "UNSPLASH_ACCESS_KEY" "${{ secrets.UNSPLASH_ACCESS_KEY }}"
            update_env "GEMINI_API_KEY" "${{ secrets.GEMINI_API_KEY }}"
            update_env "OLLAMA_BASE_URL" "http://ollama-staging:11434"
            update_env "OLLAMA_MODEL" "gemma:2b"
            update_env "NEXT_PUBLIC_SITE_URL" "http://31.97.255.107:3001"
            update_env "SLACK_WEBHOOK_CONTENT" "${{ secrets.SLACK_WEBHOOK_CONTENT }}"
            update_env "SLACK_WEBHOOK_ALERTS" "${{ secrets.SLACK_WEBHOOK_ALERTS }}"
            update_env "SLACK_WEBHOOK_DEPLOYS" "${{ secrets.SLACK_WEBHOOK_DEPLOYS }}"

            chmod 600 .env.staging
            echo "âœ… Setup complete."
            ENDSSH

      - name: Copy Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.staging.yml,scripts/*"
          target: "/var/www/hallyuhub"

      - name: Deploy via SSH (with retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          retry_wait_seconds: 15
          shell: bash
          command: |
            set -e

            # Setup SSH key
            mkdir -p ~/.ssh
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key

            # SSH with retry
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=90 \
                -o ServerAliveInterval=30 \
                -i ~/.ssh/deploy_key \
                ${{ secrets.USER }}@${{ secrets.HOST }} << ENDSSH
            set -e
            cd /var/www/hallyuhub

            # Determinar comando docker-compose (v1 vs v2)
            if docker compose version >/dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
              echo "âœ… Usando 'docker compose' (V2)"
            elif command -v docker-compose >/dev/null 2>&1; then
              COMPOSE_CMD="docker-compose"
              echo "âœ… Usando 'docker-compose' (V1)"
            else
              echo "âŒ Erro: docker-compose nÃ£o encontrado!"
              exit 1
            fi

            # DiagnÃ³stico inicial
            echo "ðŸ“Š Verificando ambiente..."
            df -h / | grep / || true
            docker network ls | grep web || echo "âš ï¸ Network 'web' nÃ£o encontrada!"

            echo "ðŸŸ¡ Deploying STAGING..."

            # Cleanup: Remove old Docker images (keep last 3)
            echo "ðŸ§¹ Limpando imagens antigas..."
            docker images ghcr.io/uchidate/khub --format "{{.ID}} {{.CreatedAt}}" | \
              tail -n +4 | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || \
              echo "Nenhuma imagem antiga para remover"

            # Pull nova imagem com log de erro
            echo "ðŸ“¥ Pulling images..."
            if ! \$COMPOSE_CMD -f docker-compose.staging.yml pull hallyuhub-staging; then
              echo "âŒ Erro ao puxar imagem do GHCR. Verifique se o servidor estÃ¡ logado (docker login ghcr.io)."
              exit 1
            fi

            # Down para evitar ContainerConfig error
            echo "ðŸ›‘ Parando containers antigos..."
            \$COMPOSE_CMD -f docker-compose.staging.yml down || true

            # Up com containers frescos
            echo "ðŸš€ Iniciando containers..."
            if ! \$COMPOSE_CMD -f docker-compose.staging.yml up -d; then
              echo "âŒ Erro ao subir containers. Verifique a network 'web' ou volumes externos."
              \$COMPOSE_CMD -f docker-compose.staging.yml logs --tail=50
              exit 1
            fi

            echo "ðŸ“Š Status dos containers:"
            \$COMPOSE_CMD -f docker-compose.staging.yml ps

            echo "â³ Aguardando container 'hallyuhub-staging' ficar operacional..."
            max_retries=20
            count=0
            until [ "\$(docker inspect -f '{{.State.Health.Status}}' hallyuhub-staging 2>/dev/null)" == "healthy" ] || [ \$count -eq \$max_retries ]; do
              health_status=\$(docker inspect -f '{{.State.Health.Status}}' hallyuhub-staging 2>/dev/null || echo "unknown")
              echo "Aguardando container ficar healthy... (Status: \$health_status, \$((count+1))/\$max_retries)"
              sleep 5
              count=\$((count+1))
            done

            if [ \$count -eq \$max_retries ]; then
              echo "âŒ Erro: Container hallyuhub-staging nÃ£o ficou healthy a tempo."
              \$COMPOSE_CMD -f docker-compose.staging.yml logs hallyuhub-staging | tail -n 50
              exit 1
            fi

            echo "ðŸ“Š Verificando migrations (Prisma)..."

            # OTIMIZAÃ‡ÃƒO: Verificar se DB jÃ¡ estÃ¡ atualizado antes de aplicar
            # Prisma 5 output: "up to date" quando nÃ£o hÃ¡ nada pendente
            echo "ðŸ” Checking for pending migrations..."
            MIGRATE_STATUS=\$(\$COMPOSE_CMD -f docker-compose.staging.yml exec -T hallyuhub-staging npx prisma migrate status 2>&1 || echo "status_failed")

            if echo "\$MIGRATE_STATUS" | grep -qi "up to date"; then
              echo "âœ… No pending migrations - skipping migrate deploy"
            else
              echo "ðŸ”„ Pending migrations detected - applying..."

              # DiagnÃ³stico de ConexÃ£o DB
              echo "ðŸ” Verificando configuraÃ§Ã£o do Banco de Dados..."
            if \$COMPOSE_CMD -f docker-compose.staging.yml exec -T hallyuhub-staging printenv DATABASE_URL > /dev/null; then
               DB_HOST=\$(\$COMPOSE_CMD -f docker-compose.staging.yml exec -T hallyuhub-staging sh -c 'echo \$DATABASE_URL' | sed -n 's/.*@\([^:]*\):.*/\1/p')
               echo "â„¹ï¸  DATABASE_URL estÃ¡ definida. Host detectado: \$DB_HOST"
               if [ "\$DB_HOST" = "localhost" ] || [ "\$DB_HOST" = "127.0.0.1" ]; then
                 echo "âš ï¸  AVISO CRÃTICO: DATABASE_URL aponta para localhost dentro do Docker! Isso geralmente falha."
                 echo "   Deveria apontar para 'postgres-staging' ou 'hallyuhub-postgres-staging'."
               fi
            else
               echo "âŒ Erro: DATABASE_URL nÃ£o estÃ¡ definida no container!"
            fi

            # Loop de retry para migration
            migrate_success=false
            for i in {1..10}; do
              echo "Tentativa de migration \$i/10..."

              # Verificar se container ainda estÃ¡ rodando (pode estar em restart loop)
              CONTAINER_STATE=\$(docker inspect -f '{{.State.Status}}' hallyuhub-staging 2>/dev/null || echo "not-found")
              if [ "\$CONTAINER_STATE" != "running" ]; then
                 echo "âš ï¸  Container hallyuhub-staging nÃ£o estÃ¡ rodando (Status: \$CONTAINER_STATE). Aguardando..."
                 \$COMPOSE_CMD -f docker-compose.staging.yml logs --tail=20 hallyuhub-staging
              else
                 if \$COMPOSE_CMD -f docker-compose.staging.yml exec -T hallyuhub-staging npx prisma migrate deploy; then
                   migrate_success=true
                   echo "âœ… Migrations aplicadas com sucesso!"
                   break
                 fi
                 echo "âš ï¸  Falha ao executar migrate deploy."
              fi

              echo "Aguardando 10s..."
              sleep 10
            done

            if [ "\$migrate_success" = false ]; then
              echo "âŒ Erro: Falha ao aplicar migrations apÃ³s 10 tentativas."
              echo "ðŸ” Logs do Banco de Dados:"
              \$COMPOSE_CMD -f docker-compose.staging.yml logs --tail=50 postgres-staging
              echo "ðŸ” Logs da AplicaÃ§Ã£o:"
              \$COMPOSE_CMD -f docker-compose.staging.yml logs --tail=50 hallyuhub-staging
              exit 1
            fi
            fi # Fim do bloco if de pending migrations

            echo "âœ… Staging containers up and healthy!"

            echo "ðŸ“ Exportando informaÃ§Ãµes dos cron jobs..."
            chmod +x scripts/export-cron-info.sh
            ./scripts/export-cron-info.sh staging

            echo "ðŸ“Š Running Staging Verification Script..."
            chmod +x scripts/setup-auto-generation.sh
            if ! NODE_ENV=staging ./scripts/setup-auto-generation.sh -f --no-test; then
              echo "âŒ CRITICAL: Staging verification failed!"
              exit 1
            fi

            echo "âœ… Staging verified and operational!"
            ENDSSH

      - name: ðŸ” Health Check
        run: |
          echo "Verificando health endpoint..."
          max_attempts=10
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -sf http://31.97.255.107:3001/api/health > /dev/null; then
              echo "âœ… Health check passou!"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Tentativa $attempt/$max_attempts falhou, aguardando..."
            sleep 5
          done

          echo "âŒ Health check falhou apÃ³s $max_attempts tentativas"
          exit 1

      - name: ðŸ” Verify SSL
        run: |
          echo "Verificando certificado SSL..."

          # Tenta 3 vezes com timeout curto
          for i in 1 2 3; do
            echo "Tentativa $i/3..."

            # Aceita 200 OK ou 307 Redirect (Next.js redirect Ã© normal)
            if curl -sS -I -L --connect-timeout 5 --max-time 10 http://31.97.255.107:3001 2>&1 | grep -qE "(200 OK|307 Temporary Redirect)"; then
              echo "âœ… SSL vÃ¡lido e site respondendo!"
              exit 0
            fi

            [ $i -lt 3 ] && sleep 3
          done

          echo "âš ï¸ SSL check timeout - mas health check passou, site deve estar OK"
          echo "â„¹ï¸ Verifique manualmente: http://31.97.255.107:3001"
          # Don't fail deployment if health check already passed
          exit 0

      - name: ðŸ“Š Summary
        if: success()
        run: |
          echo "### âœ… Deploy STAGING ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** http://31.97.255.107:3001" >> $GITHUB_STEP_SUMMARY
          echo "**Health:** âœ… OK" >> $GITHUB_STEP_SUMMARY
          echo "**SSL:** âœ… VÃ¡lido" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Fetch recent health status
          HEALTH_JSON=$(curl -s http://31.97.255.107:3001/api/health)

          echo "#### ðŸ¥ System Health (Live)" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Configured |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|------------|" >> $GITHUB_STEP_SUMMARY

          # Parse AI
          OLLAMA_STATUS=$(echo $HEALTH_JSON | jq -r '.ai.providers.ollama.available')
          OLLAMA_CONFIG=$(echo $HEALTH_JSON | jq -r '.ai.providers.ollama.configured')
          [ "$OLLAMA_STATUS" == "true" ] && O_EMOJI="âœ…" || O_EMOJI="ðŸ”´"
          [ "$OLLAMA_CONFIG" == "true" ] && OC_EMOJI="âœ…" || OC_EMOJI="âŒ"
          echo "| Ollama | $O_EMOJI | $OC_EMOJI |" >> $GITHUB_STEP_SUMMARY

          GEMINI_CONFIG=$(echo $HEALTH_JSON | jq -r '.ai.providers.gemini.configured')
          [ "$GEMINI_CONFIG" == "true" ] && GC_EMOJI="âœ…" || GC_EMOJI="âŒ"
          echo "| Gemini | - | $GC_EMOJI |" >> $GITHUB_STEP_SUMMARY

          # Parse External
          TMDB_STATUS=$(echo $HEALTH_JSON | jq -r '.monitoring.tmdb.available')
          TMDB_CONFIG=$(echo $HEALTH_JSON | jq -r '.monitoring.tmdb.configured')
          [ "$TMDB_STATUS" == "true" ] && T_EMOJI="âœ…" || T_EMOJI="ðŸ”´"
          [ "$TMDB_CONFIG" == "true" ] && TC_EMOJI="âœ…" || TC_EMOJI="âŒ"
          echo "| TMDB API | $T_EMOJI | $TC_EMOJI |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **AplicaÃ§Ã£o em produÃ§Ã£o atualizada!**" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¢ Notify Success
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | head -c 100)
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"âœ… Deploy STAGING concluÃ­do\",
              \"blocks\": [{
                \"type\": \"header\",
                \"text\": {\"type\": \"plain_text\", \"text\": \"âœ… Deploy STAGING ConcluÃ­do\"}
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Ambiente:*\\nðŸŸ¡ STAGING\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Status:*\\nSucesso\"}
                ]
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n\`${{ github.ref_name }}\`\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\\n\`${GITHUB_SHA:0:7}\`\"}
                ]
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Mensagem:*\\n> $COMMIT_MSG\"
                }
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"ðŸŽ‰ *AplicaÃ§Ã£o em produÃ§Ã£o atualizada com sucesso!*\"
                }
              }, {
                \"type\": \"divider\"
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"ðŸ”— <http://staging.hallyuhub.com.br|ðŸŒ Ver Site> Â· <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|ðŸ“ Ver Commit> Â· <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|âš™ï¸ Ver Workflow>\"
                }
              }, {
                \"type\": \"context\",
                \"elements\": [
                  {\"type\": \"mrkdwn\", \"text\": \"ðŸ‘¤ ${{ github.actor }}\"},
                  {\"type\": \"mrkdwn\", \"text\": \"âš™ï¸ GitHub Actions\"},
                  {\"type\": \"mrkdwn\", \"text\": \"âœ… Health: OK\"},
                  {\"type\": \"mrkdwn\", \"text\": \"âœ… SSL: VÃ¡lido\"}
                ]
              }]
            }"

      - name: ðŸ“¢ Notify Failure
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | head -c 100)
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"âŒ Deploy STAGING falhou\",
              \"blocks\": [{
                \"type\": \"header\",
                \"text\": {\"type\": \"plain_text\", \"text\": \"âŒ Deploy STAGING Falhou\"}
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Ambiente:*\\nðŸŸ¡ STAGING\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Status:*\\nFalhou\"}
                ]
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n\`${{ github.ref_name }}\`\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\\n\`${GITHUB_SHA:0:7}\`\"}
                ]
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Mensagem:*\\n> $COMMIT_MSG\"
                }
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"ðŸš¨ *ATENÃ‡ÃƒO: Deploy em staging falhou!*\\nVerifique os logs imediatamente e considere rollback se necessÃ¡rio.\"
                }
              }, {
                \"type\": \"divider\"
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"ðŸ”— <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|âš™ï¸ Ver Logs do Workflow> Â· <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|ðŸ“ Ver Commit>\"
                }
              }, {
                \"type\": \"context\",
                \"elements\": [
                  {\"type\": \"mrkdwn\", \"text\": \"ðŸ‘¤ ${{ github.actor }}\"},
                  {\"type\": \"mrkdwn\", \"text\": \"âš™ï¸ GitHub Actions\"}
                ]
              }]
            }"
  deploy-production:
    name: ðŸŸ¢ Deploy to Production
    needs: build-image
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.ref == 'refs/heads/main'

    environment:
      name: production
      url: https://www.hallyuhub.com.br

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¢ Notify Start
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | head -c 100)
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"ðŸš€ Deploy PRODUCTION iniciado\",
              \"blocks\": [{
                \"type\": \"header\",
                \"text\": {\"type\": \"plain_text\", \"text\": \"ðŸš€ Deploy PRODUCTION Iniciado\"}
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Ambiente:*\\nðŸŸ¢ PRODUCTION\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Status:*\\nIniciado\"}
                ]
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n\`${{ github.ref_name }}\`\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\\n\`${GITHUB_SHA:0:7}\`\"}
                ]
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Mensagem:*\\n> $COMMIT_MSG\"
                }
              }, {
                \"type\": \"divider\"
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"ðŸ”— <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|Ver Commit> Â· <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Ver Workflow>\"
                }
              }, {
                \"type\": \"context\",
                \"elements\": [
                  {\"type\": \"mrkdwn\", \"text\": \"ðŸ‘¤ ${{ github.actor }}\"},
                  {\"type\": \"mrkdwn\", \"text\": \"âš™ï¸ GitHub Actions\"}
                ]
              }]
            }"

      - name: ðŸ·ï¸ Prepare Environment & Directory (with retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          retry_wait_seconds: 15
          shell: bash
          command: |
            # Usar GitHub Action inline
            set -e

            # Install SSH if not available
            which ssh || (apt-get update && apt-get install -y openssh-client)

            # Setup SSH key
            mkdir -p ~/.ssh
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key

            # SSH with retry
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=90 \
                -o ServerAliveInterval=30 \
                -i ~/.ssh/deploy_key \
                ${{ secrets.USER }}@${{ secrets.HOST }} << ENDSSH
            set -e
            echo "ðŸ“ Ensuring base directory exists..."
            sudo mkdir -p /var/www/hallyuhub
            sudo chown -R ${{ secrets.USER }}:${{ secrets.USER }} /var/www/hallyuhub

            cd /var/www/hallyuhub

            # Initialize .env.production if it doesn't exist
            if [ ! -f .env.production ]; then
              echo "âš ï¸ .env.production not found! Creating from backup or empty..."
              if [ -f .env.production.bak ]; then
                cp .env.production.bak .env.production
              else
                touch .env.production
              fi
            fi

            # Backup
            cp .env.production .env.production.bak

            # Sanitize: remove invalid env entries (lines starting with = or empty key)
            sed -i '/^=/d' .env.production

            update_env() {
              key=\$1
              val=\$2
              if [ -z "\$val" ]; then return; fi
              if grep -q "^\${key}=" .env.production; then
                sed -i "s|^\${key}=.*|\${key}=\${val}|" .env.production
              else
                echo "\${key}=\${val}" >> .env.production
              fi
            }

            echo "ðŸ”§ Updating environment variables..."
            update_env "TMDB_API_KEY" "${{ secrets.TMDB_API_KEY }}"
            update_env "UNSPLASH_ACCESS_KEY" "${{ secrets.UNSPLASH_ACCESS_KEY }}"
            update_env "GEMINI_API_KEY" "${{ secrets.GEMINI_API_KEY }}"
            update_env "OLLAMA_BASE_URL" "http://ollama-production:11434"
            update_env "OLLAMA_MODEL" "gemma:2b"
            update_env "NEXT_PUBLIC_SITE_URL" "https://www.hallyuhub.com.br"
            update_env "SLACK_WEBHOOK_CONTENT" "${{ secrets.SLACK_WEBHOOK_CONTENT }}"
            update_env "SLACK_WEBHOOK_ALERTS" "${{ secrets.SLACK_WEBHOOK_ALERTS }}"
            update_env "SLACK_WEBHOOK_DEPLOYS" "${{ secrets.SLACK_WEBHOOK_DEPLOYS }}"

            chmod 600 .env.production
            echo "âœ… Setup complete."
            ENDSSH

      - name: Copy Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.prod.yml,scripts/*"
          target: "/var/www/hallyuhub"

      - name: Deploy via SSH (with retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 25
          max_attempts: 3
          retry_wait_seconds: 15
          shell: bash
          command: |
            set -e

            # Setup SSH key
            mkdir -p ~/.ssh
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key

            # SSH with retry
            ssh -o StrictHostKeyChecking=no \
                -o ConnectTimeout=90 \
                -o ServerAliveInterval=30 \
                -i ~/.ssh/deploy_key \
                ${{ secrets.USER }}@${{ secrets.HOST }} << ENDSSH
            set -e
            cd /var/www/hallyuhub

            # Determinar comando docker-compose (v1 vs v2)
            if docker compose version >/dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
              echo "âœ… Usando 'docker compose' (V2)"
            elif command -v docker-compose >/dev/null 2>&1; then
              COMPOSE_CMD="docker-compose"
              echo "âœ… Usando 'docker-compose' (V1)"
            else
              echo "âŒ Erro: docker-compose nÃ£o encontrado!"
              exit 1
            fi

            # DiagnÃ³stico inicial
            echo "ðŸ“Š Verificando ambiente..."
            df -h / | grep / || true
            docker network ls | grep web || echo "âš ï¸ Network 'web' nÃ£o encontrada!"

            echo "ðŸŸ¢ Deploying PRODUCTION..."

            # Cleanup: Remove old Docker images (keep last 3)
            echo "ðŸ§¹ Limpando imagens antigas..."
            docker images ghcr.io/uchidate/khub --format "{{.ID}} {{.CreatedAt}}" | \
              tail -n +4 | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || \
              echo "Nenhuma imagem antiga para remover"

            # Pull nova imagem com log de erro
            echo "ðŸ“¥ Pulling images..."
            if ! \$COMPOSE_CMD -f docker-compose.prod.yml pull hallyuhub; then
              echo "âŒ Erro ao puxar imagem do GHCR. Verifique se o servidor estÃ¡ logado (docker login ghcr.io)."
              exit 1
            fi

            # Down para evitar ContainerConfig error
            echo "ðŸ›‘ Parando containers antigos..."
            \$COMPOSE_CMD -f docker-compose.prod.yml down || true

            # Up com containers frescos
            echo "ðŸš€ Iniciando containers..."
            if ! \$COMPOSE_CMD -f docker-compose.prod.yml up -d; then
              echo "âŒ Erro ao subir containers. Verifique a network 'web' ou volumes externos."
              \$COMPOSE_CMD -f docker-compose.prod.yml logs --tail=50
              exit 1
            fi

            echo "ðŸ“Š Status dos containers:"
            \$COMPOSE_CMD -f docker-compose.prod.yml ps

            echo "â³ Aguardando container 'hallyuhub' ficar operacional..."
            max_retries=25
            count=0
            until [ "\$(docker inspect -f '{{.State.Health.Status}}' hallyuhub 2>/dev/null)" == "healthy" ] || [ \$count -eq \$max_retries ]; do
              health_status=\$(docker inspect -f '{{.State.Health.Status}}' hallyuhub 2>/dev/null || echo "unknown")
              echo "Aguardando container ficar healthy... (Status: \$health_status, \$((count+1))/\$max_retries)"
              sleep 5
              count=\$((count+1))
            done

            if [ \$count -eq \$max_retries ]; then
              echo "âŒ Erro: Container hallyuhub nÃ£o ficou healthy a tempo."
              \$COMPOSE_CMD -f docker-compose.prod.yml logs hallyuhub | tail -n 50
              exit 1
            fi

            echo "ðŸ“Š Verificando migrations (Prisma)..."

            # OTIMIZAÃ‡ÃƒO: Verificar se DB jÃ¡ estÃ¡ atualizado antes de aplicar
            # Prisma 5 output: "up to date" quando nÃ£o hÃ¡ nada pendente
            echo "ðŸ” Checking for pending migrations..."
            MIGRATE_STATUS=\$(\$COMPOSE_CMD -f docker-compose.prod.yml exec -T hallyuhub npx prisma migrate status 2>&1 || echo "status_failed")

            if echo "\$MIGRATE_STATUS" | grep -qi "up to date"; then
              echo "âœ… No pending migrations - skipping migrate deploy"
            else
              echo "ðŸ”„ Pending migrations detected - applying..."

              # DiagnÃ³stico de ConexÃ£o DB
              echo "ðŸ” Verificando configuraÃ§Ã£o do Banco de Dados..."
            if \$COMPOSE_CMD -f docker-compose.prod.yml exec -T hallyuhub printenv DATABASE_URL > /dev/null; then
               DB_HOST=\$(\$COMPOSE_CMD -f docker-compose.prod.yml exec -T hallyuhub sh -c 'echo \$DATABASE_URL' | sed -n 's/.*@\([^:]*\):.*/\1/p')
               echo "â„¹ï¸  DATABASE_URL estÃ¡ definida. Host detectado: \$DB_HOST"
               if [ "\$DB_HOST" = "localhost" ] || [ "\$DB_HOST" = "127.0.0.1" ]; then
                 echo "âš ï¸  AVISO CRÃTICO: DATABASE_URL aponta para localhost dentro do Docker! Isso geralmente falha."
                 echo "   Deveria apontar para 'postgres-production' ou 'hallyuhub-postgres-production'."
               fi
            else
               echo "âŒ Erro: DATABASE_URL nÃ£o estÃ¡ definida no container!"
            fi

            # Loop de retry para migration
            migrate_success=false
            for i in {1..10}; do
              echo "Tentativa de migration \$i/10..."

              # Verificar se container ainda estÃ¡ rodando (pode estar em restart loop)
              CONTAINER_STATE=\$(docker inspect -f '{{.State.Status}}' hallyuhub 2>/dev/null || echo "not-found")
              if [ "\$CONTAINER_STATE" != "running" ]; then
                 echo "âš ï¸  Container hallyuhub nÃ£o estÃ¡ rodando (Status: \$CONTAINER_STATE). Aguardando..."
                 \$COMPOSE_CMD -f docker-compose.prod.yml logs --tail=20 hallyuhub
              else
                 if \$COMPOSE_CMD -f docker-compose.prod.yml exec -T hallyuhub npx prisma migrate deploy; then
                   migrate_success=true
                   echo "âœ… Migrations aplicadas com sucesso!"
                   break
                 fi
                 echo "âš ï¸  Falha ao executar migrate deploy."
              fi

              echo "Aguardando 10s..."
              sleep 10
            done

            if [ "\$migrate_success" = false ]; then
              echo "âŒ Erro: Falha ao aplicar migrations apÃ³s 10 tentativas."
              echo "ðŸ” Logs do Banco de Dados:"
              \$COMPOSE_CMD -f docker-compose.prod.yml logs --tail=50 postgres-production
              echo "ðŸ” Logs da AplicaÃ§Ã£o:"
              \$COMPOSE_CMD -f docker-compose.prod.yml logs --tail=50 hallyuhub
              exit 1
            fi
            fi # Fim do bloco if de pending migrations

            echo "âœ… Production containers up and healthy!"

            echo "ðŸ“ Exportando informaÃ§Ãµes dos cron jobs..."
            chmod +x scripts/export-cron-info.sh
            ./scripts/export-cron-info.sh production

            echo "ðŸ“Š Running Production Verification Script..."
            chmod +x scripts/verify-production.sh
            if ! ./scripts/verify-production.sh; then
              echo "âŒ CRITICAL: Production verification failed!"
              exit 1
            fi

            echo "âœ… Production verified and operational!"
            ENDSSH

      - name: ðŸ” Health Check
        run: |
          echo "Verificando health endpoint..."
          max_attempts=20
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -sf https://www.hallyuhub.com.br/api/health > /dev/null; then
              echo "âœ… Health check passou!"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Tentativa $attempt/$max_attempts falhou, aguardando..."
            sleep 10
          done

          echo "âŒ Health check falhou apÃ³s $max_attempts tentativas"
          exit 1

      - name: ðŸ” Verify SSL
        run: |
          echo "Verificando certificado SSL..."

          # Tenta 3 vezes com timeout curto
          for i in 1 2 3; do
            echo "Tentativa $i/3..."

            # Aceita 200 OK ou 307 Redirect (Next.js redirect Ã© normal)
            if curl -sS -I -L --connect-timeout 5 --max-time 10 https://www.hallyuhub.com.br 2>&1 | grep -qE "(200 OK|307 Temporary Redirect)"; then
              echo "âœ… SSL vÃ¡lido e site respondendo!"
              exit 0
            fi

            [ $i -lt 3 ] && sleep 3
          done

          echo "âš ï¸ SSL check timeout - mas health check passou, site deve estar OK"
          echo "â„¹ï¸ Verifique manualmente: https://www.hallyuhub.com.br"
          # Don't fail deployment if health check already passed
          exit 0

      - name: ðŸ“Š Summary
        if: success()
        run: |
          echo "### âœ… Deploy PRODUCTION ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://www.hallyuhub.com.br" >> $GITHUB_STEP_SUMMARY
          echo "**Health:** âœ… OK" >> $GITHUB_STEP_SUMMARY
          echo "**SSL:** âœ… VÃ¡lido" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Fetch recent health status
          HEALTH_JSON=$(curl -s https://www.hallyuhub.com.br/api/health)
          
          echo "#### ðŸ¥ System Health (Live)" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Configured |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|------------|" >> $GITHUB_STEP_SUMMARY
          
          # Parse AI
          OLLAMA_STATUS=$(echo $HEALTH_JSON | jq -r '.ai.providers.ollama.available')
          OLLAMA_CONFIG=$(echo $HEALTH_JSON | jq -r '.ai.providers.ollama.configured')
          [ "$OLLAMA_STATUS" == "true" ] && O_EMOJI="âœ…" || O_EMOJI="ðŸ”´"
          [ "$OLLAMA_CONFIG" == "true" ] && OC_EMOJI="âœ…" || OC_EMOJI="âŒ"
          echo "| Ollama | $O_EMOJI | $OC_EMOJI |" >> $GITHUB_STEP_SUMMARY
          
          GEMINI_CONFIG=$(echo $HEALTH_JSON | jq -r '.ai.providers.gemini.configured')
          [ "$GEMINI_CONFIG" == "true" ] && GC_EMOJI="âœ…" || GC_EMOJI="âŒ"
          echo "| Gemini | - | $GC_EMOJI |" >> $GITHUB_STEP_SUMMARY
          
          # Parse External
          TMDB_STATUS=$(echo $HEALTH_JSON | jq -r '.monitoring.tmdb.available')
          TMDB_CONFIG=$(echo $HEALTH_JSON | jq -r '.monitoring.tmdb.configured')
          [ "$TMDB_STATUS" == "true" ] && T_EMOJI="âœ…" || T_EMOJI="ðŸ”´"
          [ "$TMDB_CONFIG" == "true" ] && TC_EMOJI="âœ…" || TC_EMOJI="âŒ"
          echo "| TMDB API | $T_EMOJI | $TC_EMOJI |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **AplicaÃ§Ã£o em produÃ§Ã£o atualizada!**" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¢ Notify Success
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | head -c 100)
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"âœ… Deploy PRODUCTION concluÃ­do\",
              \"blocks\": [{
                \"type\": \"header\",
                \"text\": {\"type\": \"plain_text\", \"text\": \"âœ… Deploy PRODUCTION ConcluÃ­do\"}
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Ambiente:*\\nðŸŸ¢ PRODUCTION\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Status:*\\nSucesso\"}
                ]
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n\`${{ github.ref_name }}\`\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\\n\`${GITHUB_SHA:0:7}\`\"}
                ]
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Mensagem:*\\n> $COMMIT_MSG\"
                }
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"ðŸŽ‰ *AplicaÃ§Ã£o em produÃ§Ã£o atualizada com sucesso!*\"
                }
              }, {
                \"type\": \"divider\"
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"ðŸ”— <https://www.hallyuhub.com.br|ðŸŒ Ver Site> Â· <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|ðŸ“ Ver Commit> Â· <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|âš™ï¸ Ver Workflow>\"
                }
              }, {
                \"type\": \"context\",
                \"elements\": [
                  {\"type\": \"mrkdwn\", \"text\": \"ðŸ‘¤ ${{ github.actor }}\"},
                  {\"type\": \"mrkdwn\", \"text\": \"âš™ï¸ GitHub Actions\"},
                  {\"type\": \"mrkdwn\", \"text\": \"âœ… Health: OK\"},
                  {\"type\": \"mrkdwn\", \"text\": \"âœ… SSL: VÃ¡lido\"}
                ]
              }]
            }"

      - name: ðŸ“¢ Notify Failure
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | head -c 100)
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"âŒ Deploy PRODUCTION falhou\",
              \"blocks\": [{
                \"type\": \"header\",
                \"text\": {\"type\": \"plain_text\", \"text\": \"âŒ Deploy PRODUCTION Falhou\"}
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Ambiente:*\\nðŸŸ¢ PRODUCTION\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Status:*\\nFalhou\"}
                ]
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n\`${{ github.ref_name }}\`\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\\n\`${GITHUB_SHA:0:7}\`\"}
                ]
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Mensagem:*\\n> $COMMIT_MSG\"
                }
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"ðŸš¨ *ATENÃ‡ÃƒO: Deploy em production falhou!*\\nVerifique os logs imediatamente e considere rollback se necessÃ¡rio.\"
                }
              }, {
                \"type\": \"divider\"
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"ðŸ”— <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|âš™ï¸ Ver Logs do Workflow> Â· <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|ðŸ“ Ver Commit>\"
                }
              }, {
                \"type\": \"context\",
                \"elements\": [
                  {\"type\": \"mrkdwn\", \"text\": \"ðŸ‘¤ ${{ github.actor }}\"},
                  {\"type\": \"mrkdwn\", \"text\": \"âš™ï¸ GitHub Actions\"}
                ]
              }]
            }"

