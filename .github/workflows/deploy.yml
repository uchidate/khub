name: üöÄ Build and Deploy

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë  FLUXO DE DEPLOY OTIMIZADO                                     ‚ïë
# ‚ïë                                                                ‚ïë
# ‚ïë  develop ‚Üí STAGING (auto) ‚Üí validar ‚Üí main ‚Üí PRODUCTION       ‚ïë
# ‚ïë                                                                ‚ïë
# ‚ïë  ‚Ä¢ Builds paralelos quando poss√≠vel                            ‚ïë
# ‚ïë  ‚Ä¢ Cache otimizado para builds r√°pidos                         ‚ïë
# ‚ïë  ‚Ä¢ Verifica√ß√£o autom√°tica p√≥s-deploy                           ‚ïë
# ‚ïë  ‚Ä¢ Notifica√ß√µes Slack consolidadas                             ‚ïë
# ‚ïë  ‚Ä¢ Timeouts e concurrency control                              ‚ïë
# ‚ïë                                                                ‚ïë
# ‚ïë  Ver: docs/DEPLOY_WORKFLOW.md                                  ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Controle de concorr√™ncia: cancela deploys antigos do mesmo branch
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üìã FASE 1: Valida√ß√£o R√°pida (paralela)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  validate-code:
    name: ‚úÖ Validate Code
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: üîç Run Linters & Type Check
        run: |
          echo "::group::ESLint"
          npx eslint app/ lib/ --max-warnings 10
          echo "::endgroup::"

          echo "::group::TypeScript"
          npx tsc --noEmit
          echo "::endgroup::"

      - name: üèóÔ∏è Test Build
        env:
          SKIP_BUILD_STATIC_GENERATION: "1"
          DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/hallyuhub_build"
        run: npm run build

      - name: üìä Summary
        run: |
          echo "### ‚úÖ Valida√ß√£o Conclu√≠da" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì ESLint passou" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì TypeScript type-check passou" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì Build Next.js passou" >> $GITHUB_STEP_SUMMARY

  check-deploy-process:
    name: üìã Check Deploy Process
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Validate Process
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" == "push" ]]; then
            echo "::warning::‚ö†Ô∏è Push direto para main detectado!"
            echo "::warning::Processo recomendado: develop ‚Üí staging ‚Üí PR ‚Üí main"

            echo "### ‚ö†Ô∏è Push Direto para Main" >> $GITHUB_STEP_SUMMARY
            echo "**Processo recomendado:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Push para \`develop\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Validar em staging" >> $GITHUB_STEP_SUMMARY
            echo "3. Criar PR: develop ‚Üí main" >> $GITHUB_STEP_SUMMARY
            echo "4. Merge ap√≥s valida√ß√£o" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "### üü° Deploy para Staging" >> $GITHUB_STEP_SUMMARY
            echo "Ap√≥s deploy, valide em: http://31.97.255.107:3001" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "### üîç Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "Apenas valida√ß√£o ser√° executada (sem deploy)" >> $GITHUB_STEP_SUMMARY
          fi

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üê≥ FASE 2: Build da Imagem Docker
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  build-image:
    name: üê≥ Build Docker Image
    needs: [validate-code, check-deploy-process]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # S√≥ builda para pushes (n√£o para PRs)
    if: github.event_name != 'pull_request'

    permissions:
      contents: read
      packages: write

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=staging,enable=${{ github.ref == 'refs/heads/develop' }}
            type=sha,prefix={{branch}}-
          labels: |
            org.opencontainers.image.title=HallyuHub
            org.opencontainers.image.description=K-pop content platform

      - name: Build and Push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Cache otimizado via GitHub Actions
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Build args
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: üìä Summary
        run: |
          echo "### üê≥ Imagem Docker Buildada" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üü° FASE 3a: Deploy STAGING
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  deploy-staging:
    name: üü° Deploy to Staging
    needs: build-image
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.ref == 'refs/heads/develop'

    environment:
      name: staging
      url: http://31.97.255.107:3001

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: üì¢ Notify Start
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | head -c 100)
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"üöÄ Deploy STAGING iniciado\",
              \"blocks\": [{
                \"type\": \"header\",
                \"text\": {\"type\": \"plain_text\", \"text\": \"üöÄ Deploy STAGING Iniciado\"}
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Ambiente:*\\nüü° STAGING\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Status:*\\nIniciado\"}
                ]
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n\`develop\`\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\\n\`${GITHUB_SHA:0:7}\`\"}
                ]
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Mensagem:*\\n> $COMMIT_MSG\"
                }
              }, {
                \"type\": \"divider\"
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üîó <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|Ver Commit> ¬∑ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Ver Workflow>\"
                }
              }, {
                \"type\": \"context\",
                \"elements\": [
                  {\"type\": \"mrkdwn\", \"text\": \"üë§ ${{ github.actor }}\"},
                  {\"type\": \"mrkdwn\", \"text\": \"‚öôÔ∏è GitHub Actions\"}
                ]
              }]
            }"

      - name: üè∑Ô∏è Prepare Environment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          sync: true
          command_timeout: 10m
          script: |
            set -e
            cd /var/www/hallyuhub
            
            if [ ! -f .env.staging ]; then
              touch .env.staging
            fi

            cp .env.staging .env.staging.bak
            
            update_env() {
              key=$1
              val=$2
              if [ -z "$val" ]; then return; fi
              if grep -q "^$key=" .env.staging; then
                sed -i "s|^$key=.*|$key=$val|" .env.staging
              else
                echo "$key=$val" >> .env.staging
              fi
            }
            
            update_env "OLLAMA_BASE_URL" "http://ollama-staging:11434"
            chmod 600 .env.staging

      - name: Copy Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.staging.yml,scripts/*"
          target: "/var/www/hallyuhub"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /var/www/hallyuhub

            echo "üü° Deploying STAGING..."

            # Cleanup: Remove old Docker images (keep last 3)
            echo "üßπ Limpando imagens antigas..."
            docker images ghcr.io/uchidate/khub --format "{{.ID}} {{.CreatedAt}}" | \
              tail -n +4 | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || \
              echo "Nenhuma imagem antiga para remover"

            # Pull nova imagem
            docker-compose -f docker-compose.staging.yml pull hallyuhub-staging

            # Down para evitar ContainerConfig error
            docker-compose -f docker-compose.staging.yml down || true

            # Up com containers frescos
            docker-compose -f docker-compose.staging.yml up -d

            echo "‚è≥ Aguardando containers ficarem saud√°veis..."
            sleep 15

            echo "üìä Aplicando migrations..."
            docker-compose -f docker-compose.staging.yml exec -T hallyuhub-staging npx prisma migrate deploy

            echo "‚è∞ Configurando Cron (Automa√ß√£o)..."
            chmod +x scripts/setup-auto-generation.sh
            NODE_ENV=staging ./scripts/setup-auto-generation.sh -f --no-test

            echo "‚úÖ Staging deployado!"

      - name: üîç Health Check
        run: |
          echo "Verificando health endpoint..."
          max_attempts=10
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -sf http://31.97.255.107:3001/api/health > /dev/null; then
              echo "‚úÖ Health check passou!"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Tentativa $attempt/$max_attempts falhou, aguardando..."
            sleep 5
          done

          echo "‚ùå Health check falhou ap√≥s $max_attempts tentativas"
          exit 1

      - name: üìä Summary
        if: success()
        run: |
          echo "### ‚úÖ Deploy STAGING Conclu√≠do" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** http://31.97.255.107:3001" >> $GITHUB_STEP_SUMMARY
          echo "**Health:** ‚úÖ OK" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pr√≥ximos passos:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Validar funcionalidades em staging" >> $GITHUB_STEP_SUMMARY
          echo "2. Criar PR: \`develop\` ‚Üí \`main\`" >> $GITHUB_STEP_SUMMARY

      - name: üì¢ Notify Success
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | head -c 100)
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"‚úÖ Deploy STAGING conclu√≠do\",
              \"blocks\": [{
                \"type\": \"header\",
                \"text\": {\"type\": \"plain_text\", \"text\": \"‚úÖ Deploy STAGING Conclu√≠do\"}
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Ambiente:*\\nüü° STAGING\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Status:*\\nSucesso\"}
                ]
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n\`develop\`\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\\n\`${GITHUB_SHA:0:7}\`\"}
                ]
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Mensagem:*\\n> $COMMIT_MSG\"
                }
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üéØ *Pr√≥ximos passos:*\\n1. Validar funcionalidades em staging\\n2. Criar PR: \`develop\` ‚Üí \`main\`\"
                }
              }, {
                \"type\": \"divider\"
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üîó <http://staging.hallyuhub.com.br|üåê Ver Site> ¬∑ <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|üìù Ver Commit> ¬∑ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|‚öôÔ∏è Ver Workflow>\"
                }
              }, {
                \"type\": \"context\",
                \"elements\": [
                  {\"type\": \"mrkdwn\", \"text\": \"üë§ ${{ github.actor }}\"},
                  {\"type\": \"mrkdwn\", \"text\": \"‚öôÔ∏è GitHub Actions\"},
                  {\"type\": \"mrkdwn\", \"text\": \"‚úÖ Health: OK\"}
                ]
              }]
            }"

      - name: üì¢ Notify Failure
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | head -c 100)
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"‚ùå Deploy STAGING falhou\",
              \"blocks\": [{
                \"type\": \"header\",
                \"text\": {\"type\": \"plain_text\", \"text\": \"‚ùå Deploy STAGING Falhou\"}
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Ambiente:*\\nüü° STAGING\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Status:*\\nFalhou\"}
                ]
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n\`develop\`\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\\n\`${GITHUB_SHA:0:7}\`\"}
                ]
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Mensagem:*\\n> $COMMIT_MSG\"
                }
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"‚ö†Ô∏è *ATEN√á√ÉO: Deploy em staging falhou!*\\nVerifique os logs imediatamente.\"
                }
              }, {
                \"type\": \"divider\"
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üîó <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|‚öôÔ∏è Ver Logs do Workflow> ¬∑ <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|üìù Ver Commit>\"
                }
              }, {
                \"type\": \"context\",
                \"elements\": [
                  {\"type\": \"mrkdwn\", \"text\": \"üë§ ${{ github.actor }}\"},
                  {\"type\": \"mrkdwn\", \"text\": \"‚öôÔ∏è GitHub Actions\"}
                ]
              }]
            }"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # üü¢ FASE 3b: Deploy PRODUCTION
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  deploy-production:
    name: üü¢ Deploy to Production
    needs: build-image
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.ref == 'refs/heads/main'

    environment:
      name: production
      url: https://www.hallyuhub.com.br

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: üì¢ Notify Start
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | head -c 100)
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"üöÄ Deploy PRODUCTION iniciado\",
              \"blocks\": [{
                \"type\": \"header\",
                \"text\": {\"type\": \"plain_text\", \"text\": \"üöÄ Deploy PRODUCTION Iniciado\"}
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Ambiente:*\\nüü¢ PRODUCTION\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Status:*\\nIniciado\"}
                ]
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n\`main\`\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\\n\`${GITHUB_SHA:0:7}\`\"}
                ]
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Mensagem:*\\n> $COMMIT_MSG\"
                }
              }, {
                \"type\": \"divider\"
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üîó <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|Ver Commit> ¬∑ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Ver Workflow>\"
                }
              }, {
                \"type\": \"context\",
                \"elements\": [
                  {\"type\": \"mrkdwn\", \"text\": \"üë§ ${{ github.actor }}\"},
                  {\"type\": \"mrkdwn\", \"text\": \"‚öôÔ∏è GitHub Actions\"}
                ]
              }]
            }"

      - name: üè∑Ô∏è Prepare Environment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          sync: true
          command_timeout: 10m
          script: |
            set -e
            echo "üìÅ Base directory prep..."
            sudo mkdir -p /var/www/hallyuhub
            sudo chown -R ${{ secrets.USER }}:${{ secrets.USER }} /var/www/hallyuhub
            
            cd /var/www/hallyuhub
            
            # Initialize .env.production if it doesn't exist
            if [ ! -f .env.production ]; then
              echo "‚ö†Ô∏è .env.production not found! Creating from backup or empty..."
              if [ -f .env.production.bak ]; then
                cp .env.production.bak .env.production
              else
                touch .env.production
              fi
            fi

            # Backup
            cp .env.production .env.production.bak
            
            update_env() {
              key=$1
              val=$2
              if [ -z "$val" ]; then
                echo "‚ö†Ô∏è Skip $key (empty value)"
                return
              fi
              if grep -q "^$key=" .env.production; then
                sed -i "s|^$key=.*|$key=$val|" .env.production
              else
                echo "$key=$val" >> .env.production
              fi
            }
            
            echo "üîß Updating sensitive keys..."
            update_env "TMDB_API_KEY" "${{ secrets.TMDB_API_KEY }}"
            update_env "GEMINI_API_KEY" "${{ secrets.GEMINI_API_KEY }}"
            update_env "OLLAMA_BASE_URL" "http://ollama-production:11434"
            
            chmod 600 .env.production
            echo "‚úÖ Env prep complete."

      - name: Copy Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.prod.yml,scripts/*"
          target: "/var/www/hallyuhub"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /var/www/hallyuhub

            # Determinar comando docker-compose (v1 vs v2)
            if docker compose version >/dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
              echo "‚úÖ Usando 'docker compose' (V2)"
            elif command -v docker-compose >/dev/null 2>&1; then
              COMPOSE_CMD="docker-compose"
              echo "‚úÖ Usando 'docker-compose' (V1)"
            else
              echo "‚ùå Erro: docker-compose n√£o encontrado!"
              exit 1
            fi

            # Diagn√≥stico inicial
            echo "üìä Verificando ambiente..."
            df -h / | grep / || true
            docker network ls | grep web || echo "‚ö†Ô∏è Network 'web' n√£o encontrada!"

            echo "üü¢ Deploying PRODUCTION..."

            # Cleanup: Remove old Docker images (keep last 3)
            echo "üßπ Limpando imagens antigas..."
            docker images ghcr.io/uchidate/khub --format "{{.ID}} {{.CreatedAt}}" | \
              tail -n +4 | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || \
              echo "Nenhuma imagem antiga para remover"

            # Pull nova imagem com log de erro
            echo "üì• Pulling images..."
            if ! $COMPOSE_CMD -f docker-compose.prod.yml pull hallyuhub; then
              echo "‚ùå Erro ao puxar imagem do GHCR. Verifique se o servidor est√° logado (docker login ghcr.io)."
              exit 1
            fi

            # Down para evitar ContainerConfig error
            echo "üõë Parando containers antigos..."
            $COMPOSE_CMD -f docker-compose.prod.yml down || true

            # Up com containers frescos
            echo "üöÄ Iniciando containers..."
            if ! $COMPOSE_CMD -f docker-compose.prod.yml up -d; then
              echo "‚ùå Erro ao subir containers. Verifique a network 'web' ou volumes externos."
              $COMPOSE_CMD -f docker-compose.prod.yml logs --tail=50
              exit 1
            fi

            echo "üìä Status dos containers:"
            $COMPOSE_CMD -f docker-compose.prod.yml ps

            echo "‚è≥ Aguardando container 'hallyuhub' ficar operacional..."
            max_retries=15
            count=0
            until [ "$(docker inspect -f '{{.State.Running}}' hallyuhub 2>/dev/null)" == "true" ] || [ $count -eq $max_retries ]; do
              echo "Aguardando container iniciar... ($((count+1))/$max_retries)"
              sleep 5
              count=$((count+1))
            done

            if [ $count -eq $max_retries ]; then
              echo "‚ùå Erro: Container hallyuhub n√£o iniciou a tempo."
              $COMPOSE_CMD -f docker-compose.prod.yml logs hallyuhub | tail -n 50
              exit 1
            fi

            echo "üìä Aplicando migrations (Prisma)..."
            
            # Diagn√≥stico de Conex√£o DB
            echo "üîç Verificando configura√ß√£o do Banco de Dados..."
            if $COMPOSE_CMD -f docker-compose.prod.yml exec -T hallyuhub printenv DATABASE_URL > /dev/null; then
               DB_HOST=$($COMPOSE_CMD -f docker-compose.prod.yml exec -T hallyuhub sh -c 'echo $DATABASE_URL' | sed -n 's/.*@\([^:]*\):.*/\1/p')
               echo "‚ÑπÔ∏è  DATABASE_URL est√° definida. Host detectado: $DB_HOST"
               if [ "$DB_HOST" = "localhost" ] || [ "$DB_HOST" = "127.0.0.1" ]; then
                 echo "‚ö†Ô∏è  AVISO CR√çTICO: DATABASE_URL aponta para localhost dentro do Docker! Isso geralmente falha."
                 echo "   Deveria apontar para 'postgres-production' ou 'hallyuhub-postgres-production'."
               fi
            else
               echo "‚ùå Erro: DATABASE_URL n√£o est√° definida no container!"
            fi

            # Loop de retry para migration
            migrate_success=false
            for i in {1..10}; do
              echo "Tentativa de migration $i/10..."
              
              # Verificar se container ainda est√° rodando (pode estar em restart loop)
              CONTAINER_STATE=$(docker inspect -f '{{.State.Status}}' hallyuhub 2>/dev/null || echo "not-found")
              if [ "$CONTAINER_STATE" != "running" ]; then
                 echo "‚ö†Ô∏è  Container hallyuhub n√£o est√° rodando (Status: $CONTAINER_STATE). Aguardando..."
                 $COMPOSE_CMD -f docker-compose.prod.yml logs --tail=20 hallyuhub
              else
                 if $COMPOSE_CMD -f docker-compose.prod.yml exec -T hallyuhub npx prisma migrate deploy; then
                   migrate_success=true
                   echo "‚úÖ Migrations aplicadas com sucesso!"
                   break
                 fi
                 echo "‚ö†Ô∏è  Falha ao executar migrate deploy."
              fi
              
              echo "Aguardando 10s..."
              sleep 10
            done

            if [ "$migrate_success" = false ]; then
              echo "‚ùå Erro: Falha ao aplicar migrations ap√≥s 10 tentativas."
              echo "üîç Logs do Banco de Dados:"
              $COMPOSE_CMD -f docker-compose.prod.yml logs --tail=50 postgres-production
              echo "üîç Logs da Aplica√ß√£o:"
              $COMPOSE_CMD -f docker-compose.prod.yml logs --tail=50 hallyuhub
              exit 1
            fi

            echo "‚úÖ Production containers up and healthy!"

            echo "üìä Running Production Verification Script..."
            chmod +x scripts/verify-production.sh
            if ! ./scripts/verify-production.sh; then
              echo "‚ùå CRITICAL: Production verification failed!"
              exit 1
            fi

            echo "‚úÖ Production verified and operational!"

      - name: üîç Health Check
        run: |
          echo "Verificando health endpoint..."
          max_attempts=20
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -sf https://www.hallyuhub.com.br/api/health > /dev/null; then
              echo "‚úÖ Health check passou!"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Tentativa $attempt/$max_attempts falhou, aguardando..."
            sleep 10
          done

          echo "‚ùå Health check falhou ap√≥s $max_attempts tentativas"
          exit 1

      - name: üîç Verify SSL
        run: |
          echo "Verificando certificado SSL..."

          # Tenta 3 vezes com timeout curto
          for i in 1 2 3; do
            echo "Tentativa $i/3..."

            # Aceita 200 OK ou 307 Redirect (Next.js redirect √© normal)
            if curl -sS -I -L --connect-timeout 5 --max-time 10 https://www.hallyuhub.com.br 2>&1 | grep -qE "(200 OK|307 Temporary Redirect)"; then
              echo "‚úÖ SSL v√°lido e site respondendo!"
              exit 0
            fi

            [ $i -lt 3 ] && sleep 3
          done

          echo "‚ö†Ô∏è SSL check timeout - mas health check passou, site deve estar OK"
          echo "‚ÑπÔ∏è Verifique manualmente: https://www.hallyuhub.com.br"
          # Don't fail deployment if health check already passed
          exit 0

      - name: üìä Summary
        if: success()
        run: |
          echo "### ‚úÖ Deploy PRODUCTION Conclu√≠do" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://www.hallyuhub.com.br" >> $GITHUB_STEP_SUMMARY
          echo "**Health:** ‚úÖ OK" >> $GITHUB_STEP_SUMMARY
          echo "**SSL:** ‚úÖ V√°lido" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéâ **Aplica√ß√£o em produ√ß√£o atualizada!**" >> $GITHUB_STEP_SUMMARY

      - name: üì¢ Notify Success
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | head -c 100)
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"‚úÖ Deploy PRODUCTION conclu√≠do\",
              \"blocks\": [{
                \"type\": \"header\",
                \"text\": {\"type\": \"plain_text\", \"text\": \"‚úÖ Deploy PRODUCTION Conclu√≠do\"}
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Ambiente:*\\nüü¢ PRODUCTION\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Status:*\\nSucesso\"}
                ]
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n\`main\`\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\\n\`${GITHUB_SHA:0:7}\`\"}
                ]
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Mensagem:*\\n> $COMMIT_MSG\"
                }
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üéâ *Aplica√ß√£o em produ√ß√£o atualizada com sucesso!*\"
                }
              }, {
                \"type\": \"divider\"
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üîó <https://www.hallyuhub.com.br|üåê Ver Site> ¬∑ <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|üìù Ver Commit> ¬∑ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|‚öôÔ∏è Ver Workflow>\"
                }
              }, {
                \"type\": \"context\",
                \"elements\": [
                  {\"type\": \"mrkdwn\", \"text\": \"üë§ ${{ github.actor }}\"},
                  {\"type\": \"mrkdwn\", \"text\": \"‚öôÔ∏è GitHub Actions\"},
                  {\"type\": \"mrkdwn\", \"text\": \"‚úÖ Health: OK\"},
                  {\"type\": \"mrkdwn\", \"text\": \"‚úÖ SSL: V√°lido\"}
                ]
              }]
            }"

      - name: üì¢ Notify Failure
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | head -c 100)
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"‚ùå Deploy PRODUCTION falhou\",
              \"blocks\": [{
                \"type\": \"header\",
                \"text\": {\"type\": \"plain_text\", \"text\": \"‚ùå Deploy PRODUCTION Falhou\"}
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Ambiente:*\\nüü¢ PRODUCTION\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Status:*\\nFalhou\"}
                ]
              }, {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*Branch:*\\n\`main\`\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\\n\`${GITHUB_SHA:0:7}\`\"}
                ]
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Mensagem:*\\n> $COMMIT_MSG\"
                }
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üö® *ATEN√á√ÉO: Deploy em produ√ß√£o falhou!*\\nVerifique os logs imediatamente e considere rollback se necess√°rio.\"
                }
              }, {
                \"type\": \"divider\"
              }, {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üîó <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|‚öôÔ∏è Ver Logs do Workflow> ¬∑ <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|üìù Ver Commit>\"
                }
              }, {
                \"type\": \"context\",
                \"elements\": [
                  {\"type\": \"mrkdwn\", \"text\": \"üë§ ${{ github.actor }}\"},
                  {\"type\": \"mrkdwn\", \"text\": \"‚öôÔ∏è GitHub Actions\"}
                ]
              }]
            }"
