name: üìä Apply Database Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to apply migrations'
        required: true
        type: choice
        options:
          - staging
          - production

jobs:
  apply-migrations:
    name: üìä Apply Migrations to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Apply Migrations via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /var/www/hallyuhub

            if [ "${{ inputs.environment }}" = "staging" ]; then
              echo "üìä Aplicando migrations no STAGING..."
              docker-compose -f docker-compose.staging.yml exec -T hallyuhub-staging npx prisma migrate deploy
              echo "‚úÖ Migrations aplicadas no staging!"
            elif [ "${{ inputs.environment }}" = "production" ]; then
              echo "üìä Aplicando migrations na PRODUCTION..."
              docker-compose -f docker-compose.prod.yml exec -T hallyuhub npx prisma migrate deploy
              echo "‚úÖ Migrations aplicadas na production!"
            fi

      - name: üîç Verify Deployment
        run: |
          if [ "${{ inputs.environment }}" = "staging" ]; then
            URL="http://31.97.255.107:3001/api/health"
          else
            URL="https://www.hallyuhub.com.br/api/health"
          fi

          echo "Verificando $URL..."
          if curl -sf "$URL" > /dev/null; then
            echo "‚úÖ ${{ inputs.environment }} est√° respondendo corretamente!"
          else
            echo "‚ö†Ô∏è Falha ao verificar health endpoint"
            exit 1
          fi

      - name: üìä Summary
        run: |
          echo "### ‚úÖ Migrations Aplicadas" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ Sucesso" >> $GITHUB_STEP_SUMMARY

      - name: üì¢ Notify Success
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "‚úÖ Migrations aplicadas em ${{ inputs.environment }}",
              "blocks": [{
                "type": "header",
                "text": {"type": "plain_text", "text": "‚úÖ Migrations Aplicadas"}
              }, {
                "type": "section",
                "fields": [
                  {"type": "mrkdwn", "text": "*Environment:* `${{ inputs.environment }}`"},
                  {"type": "mrkdwn", "text": "*Status:* ‚úÖ Sucesso"}
                ]
              }]
            }'

      - name: üì¢ Notify Failure
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_DEPLOYS }}
        run: |
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "‚ùå Falha ao aplicar migrations em ${{ inputs.environment }}",
              "blocks": [{
                "type": "header",
                "text": {"type": "plain_text", "text": "‚ùå Falha nas Migrations"}
              }, {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "üîó <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Ver logs>"
                }
              }]
            }'
