name: Content Generation (Production)

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes (production)
  workflow_dispatch:        # Allows manual trigger

jobs:
  generate-content:
    name: Generate AI Content
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ¤– Generate content with Ollama (Production)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/hallyuhub

            echo "ğŸ¤– Starting content generation in PRODUCTION..."
            echo "ğŸ“… $(date)"
            echo ""

            # Generate content using Ollama (free, local AI)
            # 2 artists + 1 production every 15 minutes
            docker exec hallyuhub sh -c "npm run atualize:ai -- --provider=ollama --artists=2 --productions=1 --news=0"

            if [ $? -eq 0 ]; then
              echo ""
              echo "âœ… Content generation completed successfully!"
            else
              echo ""
              echo "âŒ Content generation failed, check logs"
              exit 1
            fi

      - name: ğŸ“Š Verify database stats
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ“Š Current database stats (PostgreSQL):"
            docker exec hallyuhub npx prisma db execute --stdin <<'EOF'
              SELECT
                (SELECT COUNT(*) FROM "Artist") as artists,
                (SELECT COUNT(*) FROM "Production") as productions,
                (SELECT COUNT(*) FROM "News") as news;
            EOF
