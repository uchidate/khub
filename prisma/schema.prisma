// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Agency {
  id        String   @id @default(cuid())
  name      String   @unique
  website   String?
  socials   Json?
  artists   Artist[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdAt])
  @@index([name])
}

model Artist {
  id                 String             @id @default(cuid())
  nameRomanized      String             @unique
  nameHangul         String?
  birthDate          DateTime?
  birthName          String?
  stageNames         String[]
  roles              String[]
  height             String?
  bloodType          String?
  zodiacSign         String?
  bio                String?
  primaryImageUrl    String?
  socialLinks        Json?
  agency             Agency?            @relation(fields: [agencyId], references: [id])
  agencyId           String?
  productions        ArtistProduction[]
  // TMDB sync tracking
  tmdbId             String? @unique // TMDB person ID
  tmdbSyncStatus     String? // 'SYNCED', 'NOT_FOUND', 'ERROR'
  tmdbLastSync       DateTime? // Last successful sync
  tmdbLastAttempt    DateTime? // Last attempt (even if failed)
  // Trending metrics
  viewCount          Int                @default(0)
  favoriteCount      Int                @default(0)
  lastTrendingUpdate DateTime?
  trendingScore      Float              @default(0.0)
  // Translation tracking
  translationStatus  String             @default("pending") // 'pending', 'completed', 'failed'
  translatedAt       DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  userFavorites      Favorite[]
  albums             Album[]
  news               NewsArtist[]

  @@index([agencyId])
  @@index([createdAt])
  @@index([birthDate])
  @@index([nameRomanized, createdAt])
  @@index([tmdbSyncStatus])
  @@index([tmdbLastSync])
  @@index([tmdbSyncStatus, tmdbLastSync])
  @@index([trendingScore])
  @@index([translationStatus])
  @@index([translationStatus, createdAt])
}

model Album {
  id          String    @id @default(cuid())
  title       String
  type        String // 'ALBUM', 'EP', 'SINGLE'
  releaseDate DateTime?
  coverUrl    String?

  // Streaming Links
  spotifyUrl    String?
  appleMusicUrl String?
  youtubeUrl    String?

  artistId String
  artist   Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([artistId])
  @@index([releaseDate])
}

model Production {
  id                 String             @id @default(cuid())
  titlePt            String             @unique
  titleKr            String?
  type               String
  year               Int?
  synopsis           String?
  imageUrl           String? // Poster image
  backdropUrl        String? // Banner/backdrop image
  galleryUrls        String[] // Additional images
  streamingPlatforms String[]
  sourceUrls         String[]
  tags               String[]
  artists            ArtistProduction[]
  // TMDB metadata
  tmdbId             String? // TMDB movie/TV ID
  tmdbType           String? // 'movie' or 'tv'
  releaseDate        DateTime? // Precise release date
  runtime            Int? // Minutes
  voteAverage        Float? // TMDB rating
  trailerUrl         String? // YouTube trailer URL
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  userFavorites      Favorite[]

  @@index([type])
  @@index([year])
  @@index([createdAt])
  @@index([type, year])
  @@index([titlePt])
  @@index([tmdbId])
  @@index([releaseDate])
}

model ArtistProduction {
  artist       Artist     @relation(fields: [artistId], references: [id])
  artistId     String
  production   Production @relation(fields: [productionId], references: [id])
  productionId String
  role         String?

  @@id([artistId, productionId])
}

model News {
  id                  String                @id @default(cuid())
  title               String
  contentMd           String
  sourceUrl           String                @unique
  publishedAt         DateTime              @default(now())
  imageUrl            String?
  tags                String[]
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  userFavorites       Favorite[]
  artists             NewsArtist[]
  notificationHistory NotificationHistory[]
  comments            Comment[]

  @@index([publishedAt])
  @@index([createdAt])
  @@index([title])
  @@index([sourceUrl])
}

model NewsArtist {
  id       String @id @default(cuid())
  newsId   String
  artistId String

  news     News   @relation(fields: [newsId], references: [id], onDelete: Cascade)
  artist   Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([newsId, artistId])
  @@index([newsId])
  @@index([artistId])
}

model Image {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  url        String
  credit     String?
  license    String?
  width      Int?
  height     Int?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}

model User {
  id                     String                       @id @default(cuid())
  name                   String?
  email                  String                       @unique
  emailVerified          DateTime?
  password               String?
  image                  String?
  role                   String                       @default("user") // 'admin' | 'editor' | 'user'
  accounts               Account[]
  sessions               Session[]
  createdAt              DateTime                     @default(now())
  updatedAt              DateTime                     @updatedAt
  favorites              Favorite[]
  activities             Activity[]
  notificationSettings   UserNotificationSettings?
  notificationHistory    NotificationHistory[]
  comments               Comment[]

  @@index([email])
}

model UserNotificationSettings {
  id                   String   @id @default(cuid())
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Tipos de notificação
  emailOnNewNews       Boolean  @default(true)
  emailDigestEnabled   Boolean  @default(true)
  emailDigestFrequency String   @default("DAILY") // 'DAILY', 'WEEKLY', 'NEVER'
  emailDigestTime      String   @default("09:00") // HH:mm format

  // Filtros
  onlyFavoriteArtists  Boolean  @default(true)
  minNewsImportance    String   @default("ALL") // 'ALL', 'HIGH', 'CRITICAL'

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
}

model NotificationHistory {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  newsId       String
  news         News      @relation(fields: [newsId], references: [id], onDelete: Cascade)
  type         String    // 'EMAIL_INSTANT', 'EMAIL_DIGEST', 'PUSH'
  status       String    @default("PENDING") // 'PENDING', 'SENT', 'FAILED'
  sentAt       DateTime?
  errorMessage String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
  @@index([newsId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([userId, newsId, type])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
  @@index([email])
}

model Tag {
  id   String @id @default(cuid())
  name String @unique
  type String

  @@index([type])
  @@index([name])
}

model Favorite {
  id           String      @id @default(cuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  artistId     String?
  artist       Artist?     @relation(fields: [artistId], references: [id], onDelete: Cascade)
  productionId String?
  production   Production? @relation(fields: [productionId], references: [id], onDelete: Cascade)
  newsId       String?
  news         News?       @relation(fields: [newsId], references: [id], onDelete: Cascade)
  createdAt    DateTime    @default(now())

  @@unique([userId, artistId])
  @@unique([userId, productionId])
  @@unique([userId, newsId])
  @@index([userId])
  @@index([artistId])
  @@index([productionId])
  @@index([newsId])
}

model Activity {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type       String // 'VIEW', 'LIKE', 'LOGIN', 'SEARCH'
  entityId   String? // Artist ID, Production ID, or News ID
  entityType String? // 'ARTIST', 'PRODUCTION', 'NEWS'
  metadata   Json? // Additional context
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  newsId    String
  news      News     @relation(fields: [newsId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([newsId])
  @@index([userId])
  @@index([createdAt])
  @@index([newsId, createdAt])
}

model CronLock {
  id        String   @id @default("cron-update")
  lockedBy  String
  lockedAt  DateTime @default(now())
  expiresAt DateTime

  @@map("cron_locks")
}

// Log de descoberta de artistas (evita repetição a curto prazo)
model ArtistDiscoveryLog {
  id          String   @id @default(cuid())
  tmdbId      Int      // TMDB ID do artista tentado
  wasAdded    Boolean  @default(false) // Se foi adicionado ao banco ou já existia
  attemptedAt DateTime @default(now())
  source      String?  // 'popular', 'trending', 'kdrama', 'movie'

  @@index([tmdbId])
  @@index([attemptedAt])
  @@index([tmdbId, attemptedAt])
  @@map("artist_discovery_log")
}
